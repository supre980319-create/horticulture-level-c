<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作答中｜園藝丙級術科識別線上模擬測驗</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:0;background:#f6f7fb}
    header{background:#111827;color:#fff;padding:20px 0}
    .container{max-width:980px;margin:0 auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.07);margin:18px 0}
    .muted{opacity:.8;line-height:1.55}
    .quizTop{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .progress{font-weight:900}
    .timer{font-weight:900}
    .imgBox{margin:14px 0;background:#0b1220;border-radius:14px;display:flex;justify-content:center;align-items:center;overflow:hidden}
    .imgBox img{max-width:100%;height:auto;display:block}
    .options{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0}
    .optBtn{border:1px solid #d1d5db;border-radius:12px;padding:12px 14px;background:#fff;cursor:pointer;text-align:left;font-weight:800}
    .optBtn .label{display:inline-block;min-width:28px}
    .optBtn.selected{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}
    .navRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:800;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111827}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .footerNote{margin-top:12px;font-size:13px;opacity:.75}
    .warn{color:#b45309;font-weight:900}
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>作答頁</h1>
    <div class="muted">40 分鐘倒數，做完可以交卷；也會在時間到時自動交卷。</div>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="quizTop">
      <div class="progress">第 <span id="qIndex">1</span> / 100 題</div>
      <div class="timer">剩餘時間：<span id="timeLeft">40:00</span></div>
    </div>

    <div id="loadWarn" class="warn" style="display:none;margin-top:10px;"></div>

    <div class="imgBox">
      <img id="qImg" alt="題目圖片" />
    </div>

    <div class="options" id="options"></div>

    <div class="navRow">
      <button class="secondary" id="prevBtn">上一題</button>
      <div class="row">
        <button class="secondary" id="saveExitBtn">儲存並離開</button>
        <button id="submitBtn">交卷</button>
      </div>
      <button class="secondary" id="nextBtn">下一題</button>
    </div>

    <div class="footerNote">
      規則：每題 1 個正確選項 + 3 個錯誤選項。若某題選項缺失，系統會自動補齊 4 個選項。
    </div>
  </div>
</main>

<script>
const LS_KEYS = { quizState: 'quizState_v2', result: 'result_v2' };

function loadState(){
  const raw = localStorage.getItem(LS_KEYS.quizState);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveState(state){
  localStorage.setItem(LS_KEYS.quizState, JSON.stringify(state));
}
function pad2(n){ return String(n).padStart(2,'0'); }
function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return pad2(m)+':'+pad2(s);
}
function pretty(x){
  if(!x) return '';
  return String(x).replaceAll('_',' / ');
}
function uniq(arr){
  const out = [];
  const seen = new Set();
  for(const x of arr){
    const v = (x ?? '').toString().trim();
    if(!v) continue;
    if(seen.has(v)) continue;
    seen.add(v);
    out.push(v);
  }
  return out;
}
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/** 從 Cloudinary public_id 萃取「中文名稱」：移除末段亂碼、移除角度編號 */
function baseNameFromPublicId(pid){
  const parts = String(pid||'').split('_').filter(Boolean);
  if(parts.length <= 1) return String(pid||'');
  // 最後一段通常是亂碼；倒數第二段可能是角度編號
  const last = parts[parts.length-1];
  const prev = parts[parts.length-2];
  const cut = (prev && /^\d+$/.test(prev)) ? parts.slice(0,-2) : parts.slice(0,-1);
  return cut.join('_');
}

let DB = null;              // all_images.json
let NAME_TO_FOLDER = null;  // name -> A..H
let POOLS = null;           // A..H -> [names]

async function loadDb(){
  if(DB) return DB;
  const res = await fetch('./all_images.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('無法載入 all_images.json（HTTP '+res.status+'）');
  DB = await res.json();

  // build pools
  const pools = {};
  const map = {};
  const folders = (DB && DB.folders) ? DB.folders : {};
  for(const k of Object.keys(folders)){
    const imgs = folders[k]?.images || [];
    const names = [];
    for(const it of imgs){
      const nm = baseNameFromPublicId(it.public_id);
      if(nm) names.push(nm);
    }
    const u = uniq(names);
    pools[k] = u;
    for(const nm of u){
      if(!(nm in map)) map[nm] = k;
    }
  }
  POOLS = pools;
  NAME_TO_FOLDER = map;
  return DB;
}

function getQField(q, keys, fallback){
  for(const k of keys){
    if(q && q[k] !== undefined && q[k] !== null) return q[k];
  }
  return fallback;
}

/** 確保每題都有 4 個選項，且包含正確答案 */
function ensureFourOptions(q){
  const correct = getQField(q, ['correct','answer','ans'], '').toString().trim();
  let opts = getQField(q, ['options','choices'], []);
  if(!Array.isArray(opts)) opts = [];

  // 如果這題已經固定過選項，就不要再洗牌
  if(q && q.__optionsFixed && opts.length === 4){
    return opts;
  }

  opts = uniq(opts.map(x => x.toString().trim()).filter(Boolean));
  if(correct && !opts.includes(correct)) opts.unshift(correct);
  opts = uniq(opts);

  const folder = getQField(q, ['folder','category','cat','type'], '').toString().trim();
  const poolSame = (folder && POOLS[folder]) ? POOLS[folder].slice() : [];
  const poolAll = Object.values(POOLS).flat().slice();

  function fillFrom(pool){
    shuffle(pool);
    for(const name of pool){
      const n = name.toString().trim();
      if(n && !opts.includes(n)){
        opts.push(n);
        if(opts.length >= 4) break;
      }
    }
  }

  if(opts.length < 4) fillFrom(poolSame);
  if(opts.length < 4) fillFrom(poolAll);

  // 強制保留 correct
  if(correct && !opts.includes(correct)){
    opts = [correct, ...opts.filter(x => x !== correct)];
  }

  opts = opts.slice(0,4);
  opts = shuffle(opts); // 只在第一次固定時洗牌一次

  // 固定住（之後導覽回來不會亂跳）
  q.options = opts;
  q.__optionsFixed = true;
  return opts;
}

function render(state){
  const idx = state.currentIndex;
  const q = state.questions[idx];

  document.getElementById('qIndex').textContent = String(idx + 1);

  const img = document.getElementById('qImg');
  const imgUrl = getQField(q, ['imgUrl','imageUrl','url'], '');
  img.src = imgUrl || '';
  img.onerror = () => { img.alt = '圖片載入失敗'; };

  // ensure options
  const opts = ensureFourOptions(q);
  q.options = opts;               // 存回去，確保前後一致
  q.correct = getQField(q, ['correct','answer','ans'], q.correct); // normalize
  q.imgUrl = imgUrl;              // normalize
  saveState(state);

  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';

  const chosen = state.answers[idx];
  const labels = ['A','B','C','D'];

  opts.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'optBtn' + (chosen === opt ? ' selected' : '');
    btn.type = 'button';
    btn.innerHTML = `<span class="label">${labels[i]}.</span> ${pretty(opt)}`;
    btn.addEventListener('click', () => {
      state.answers[idx] = opt;
      saveState(state);
      render(state);
    });
    optionsDiv.appendChild(btn);
  });

  document.getElementById('prevBtn').disabled = (idx === 0);
  document.getElementById('nextBtn').disabled = (idx === 99);
}

function submit(state){
  let score = 0;
  const details = [];
  for(let i=0;i<100;i++){
    const q = state.questions[i];
    const correct = getQField(q, ['correct','answer','ans'], '');
    const imgUrl = getQField(q, ['imgUrl','imageUrl','url'], '');
    const a = state.answers[i];
    const ok = (a && a === correct);
    if(ok) score++;
    details.push({
      no: i+1,
      your: a,
      correct,
      ok,
      imgUrl
    });
  }
  const result = {
    playerName: state.playerName || '匿名',
    score,
    details,
    finishedAt: Date.now(),
  };
  localStorage.setItem(LS_KEYS.result, JSON.stringify(result));
  window.location.href = './result.html';
}

(async function init(){
  const warn = document.getElementById('loadWarn');
  const state = loadState();

  if(!state || !state.questions || state.questions.length !== 100){
    warn.style.display = 'block';
    warn.textContent = '找不到測驗資料（quizState_v2）。請回首頁重新開始。';
    document.getElementById('prevBtn').disabled = true;
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('saveExitBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    return;
  }

  // 載入 all_images.json，讓「缺選項」時可自動補齊
  try{
    await loadDb();
  }catch(e){
    // 不阻擋作答；只是無法自動補齊錯誤選項
    console.warn(e);
  }

  // timer
  const tick = () => {
    const elapsed = (Date.now() - state.startTime) / 1000;
    const left = state.durationSec - elapsed;
    document.getElementById('timeLeft').textContent = formatTime(left);
    if(left <= 0) submit(state);
  };
  tick();
  setInterval(tick, 500);

  // buttons
  document.getElementById('prevBtn').addEventListener('click', () => {
    state.currentIndex = Math.max(0, state.currentIndex - 1);
    saveState(state);
    render(state);
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    state.currentIndex = Math.min(99, state.currentIndex + 1);
    saveState(state);
    render(state);
  });
  document.getElementById('saveExitBtn').addEventListener('click', () => {
    saveState(state);
    window.location.href = './index.html';
  });
  document.getElementById('submitBtn').addEventListener('click', () => {
    if(confirm('確定要交卷嗎？')) submit(state);
  });

  render(state);
})();
</script>
</body>
</html>
