<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作答中｜園藝丙級術科識別線上模擬測驗</title>
  <link rel="stylesheet" href="./style.css" />
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC","Microsoft JhengHei",sans-serif;margin:0;background:#f6f7fb}
    header{background:#111827;color:#fff;padding:20px 0}
    .container{max-width:980px;margin:0 auto;padding:0 16px}
    .card{background:#fff;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.07);margin:18px 0}
    .muted{opacity:.8;line-height:1.55}
    .quizTop{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .pillRow{display:flex;gap:10px;flex-wrap:wrap}
    .pill{background:#eef2ff;border:1px solid #e5e7eb;color:#111827;border-radius:999px;padding:8px 12px;font-weight:900}
    .progress{font-weight:900}
    .timer{font-weight:900}
    .imgBox{margin:14px 0;background:#0b1220;border-radius:14px;display:flex;justify-content:center;align-items:center;overflow:hidden}
    .imgBox img{max-width:100%;height:auto;display:block}

    .options{display:grid;grid-template-columns:1fr;gap:10px;margin:12px 0}
    .opt{border:1px solid #d1d5db;border-radius:12px;padding:12px 14px;background:#fff;cursor:pointer;text-align:left;font-weight:900;display:flex;align-items:center;gap:10px}
    .opt input{transform:scale(1.1);margin:0 4px 0 2px}
    .opt .label{min-width:28px;font-weight:1000}
    .opt.selected{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.15)}

    .navRow{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{padding:10px 14px;border:0;border-radius:10px;background:#2563eb;color:#fff;font-weight:900;cursor:pointer}
    button.secondary{background:#e5e7eb;color:#111827}
    button:disabled{opacity:.5;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .footerNote{margin-top:12px;font-size:13px;opacity:.78}
    .warn{color:#b45309;font-weight:900}

    /* 題目導覽（1~100） */
    .navTitle{margin-top:14px;font-weight:900;opacity:.85}
    .grid{display:grid;grid-template-columns:repeat(10, minmax(0,1fr));gap:8px;margin-top:10px}
    .qBtn{border:1px solid #e5e7eb;border-radius:10px;background:#f3f4f6;padding:8px 0;font-weight:900;color:#111827;cursor:pointer}
    .qBtn.current{border-color:#2563eb;background:#eef2ff}
    .qBtn.answered{background:#dcfce7;border-color:#86efac}
    .qBtn.current.answered{background:#dbeafe;border-color:#60a5fa}
    @media (max-width:520px){ .grid{grid-template-columns:repeat(5, minmax(0,1fr));} }
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>作答頁</h1>
    <div class="muted">40 分鐘倒數，做完可以交卷；也會在時間到時自動交卷。</div>
  </div>
</header>

<main class="container">
  <div class="card">
    <div class="pillRow" style="margin-bottom:12px">
      <div class="pill">考生：<span id="playerName">—</span></div>
      <div class="pill">題數：<span id="totalQ">100</span></div>
      <div class="pill">剩餘：<span id="timeLeft">40:00</span></div>
    </div>

    <div class="quizTop">
      <div class="progress">第 <span id="qIndex">1</span> / <span id="qTotal2">100</span> 題</div>
      <div class="timer">（可前後翻題）</div>
    </div>

    <div id="loadWarn" class="warn" style="display:none;margin-top:10px;"></div>

    <div class="imgBox">
      <img id="qImg" alt="題目圖片" />
    </div>

    <div class="options" id="options"></div>

    <div class="navRow">
      <button class="secondary" id="prevBtn">← 上一題</button>
      <div class="row">
        <button class="secondary" id="saveExitBtn">儲存並離開</button>
        <button id="submitBtn">交卷</button>
      </div>
      <button class="secondary" id="nextBtn">下一題 →</button>
    </div>

    <div class="navTitle">題目導覽</div>
    <div class="grid" id="qGrid"></div>

    <div class="footerNote">
      規則：每題一定會有 4 個選項（A~D）。若某題選項不足，系統會從 <code>all_images.json</code> 自動補齊，並且<strong>同一題前後翻題選項順序固定</strong>。
    </div>
  </div>
</main>

<script>
const LS_KEYS = { quizState: 'quizState_v2', result: 'result_v2' };

function loadState(){
  const raw = localStorage.getItem(LS_KEYS.quizState);
  if(!raw) return null;
  try{ return JSON.parse(raw); }catch{ return null; }
}
function saveState(state){
  localStorage.setItem(LS_KEYS.quizState, JSON.stringify(state));
}
function pad2(n){ return String(n).padStart(2,'0'); }
function formatTime(sec){
  sec = Math.max(0, Math.floor(sec));
  const m = Math.floor(sec/60), s = sec%60;
  return pad2(m)+':'+pad2(s);
}
function pretty(x){
  if(!x) return '';
  return String(x).replaceAll('_',' / ');
}
function uniq(arr){
  const out = [];
  const seen = new Set();
  for(const x of arr){
    const v = (x ?? '').toString().trim();
    if(!v) continue;
    if(seen.has(v)) continue;
    seen.add(v);
    out.push(v);
  }
  return out;
}
function hashStr(s){
  // simple 32-bit FNV-1a
  let h = 2166136261;
  s = String(s ?? '');
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function seededShuffle(arr, seed){
  const a = arr.slice();
  let x = seed >>> 0;
  const rnd = () => {
    // xorshift32
    x ^= x << 13; x >>>= 0;
    x ^= x >>> 17; x >>>= 0;
    x ^= x << 5;  x >>>= 0;
    return (x >>> 0) / 4294967296;
  };
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

/** 從 Cloudinary public_id 萃取「中文名稱」：移除末段亂碼、移除角度編號 */
function baseNameFromPublicId(pid){
  const parts = String(pid||'').split('_').filter(Boolean);
  if(parts.length <= 1) return String(pid||'');
  const prev = parts[parts.length-2];
  const cut = (prev && /^\d+$/.test(prev)) ? parts.slice(0,-2) : parts.slice(0,-1);
  return cut.join('_');
}

let DB = null;              // all_images.json
let NAME_TO_FOLDER = null;  // name -> A..H
let POOLS = null;           // A..H -> [names]

async function loadDb(){
  if(DB) return DB;
  const res = await fetch('./all_images.json', { cache: 'no-store' });
  if(!res.ok) throw new Error('無法載入 all_images.json（HTTP '+res.status+'）');
  DB = await res.json();

  const pools = {};
  const map = {};
  const folders = (DB && DB.folders) ? DB.folders : {};
  for(const k of Object.keys(folders)){
    const imgs = folders[k]?.images || [];
    const names = [];
    for(const it of imgs){
      const nm = baseNameFromPublicId(it.public_id);
      if(nm) names.push(nm);
    }
    const u = uniq(names);
    pools[k] = u;
    for(const nm of u){
      if(!(nm in map)) map[nm] = k;
    }
  }
  POOLS = pools;
  NAME_TO_FOLDER = map;
  return DB;
}

function getQField(q, keys, fallback){
  for(const k of keys){
    if(q && q[k] !== undefined && q[k] !== null) return q[k];
  }
  return fallback;
}

/** 確保每題都有 4 個選項，且包含正確答案（並固定順序） */
function ensureFourOptionsStable(q, qIndex){
  const correct = getQField(q, ['correct','answer','ans'], '').toString().trim();
  let opts = getQField(q, ['options','choices'], []);
  if(!Array.isArray(opts)) opts = [];
  opts = uniq(opts);
  if(correct && !opts.includes(correct)) opts.unshift(correct);
  opts = uniq(opts);

  // 如果已經 4 個（或以上）→ 截成 4，但一定保留 correct
  if(opts.length >= 4){
    let four = opts.slice(0,4);
    if(correct && !four.includes(correct)){
      four = [correct, ...opts.filter(x => x !== correct).slice(0,3)];
    }
    // 固定 shuffle：同題永遠同順序（不會每次 render 亂跳）
    const seed = hashStr(correct + '|' + qIndex + '|stable');
    return seededShuffle(four, seed);
  }

  // 需要補齊：從同資料夾（同類別）找錯誤選項
  const cat = getQField(q, ['cat','category','folderKey','group','section'], null);
  let folderKey = cat;
  if(!folderKey && correct) folderKey = NAME_TO_FOLDER?.[correct] || null;

  let pool = [];
  if(folderKey && POOLS && POOLS[folderKey]) pool = POOLS[folderKey];
  else if(POOLS) pool = Object.values(POOLS).flat();

  const candidates = pool.filter(nm => nm !== correct && !opts.includes(nm));
  const need = 4 - opts.length;
  const add = seededShuffle(candidates, hashStr('add|'+correct+'|'+qIndex)).slice(0, need);
  let finalOpts = uniq([...opts, ...add]);

  // 若還不足（極少數），用全域補
  if(finalOpts.length < 4 && POOLS){
    const global = Object.values(POOLS).flat().filter(nm => nm !== correct && !finalOpts.includes(nm));
    finalOpts.push(...seededShuffle(global, hashStr('global|'+correct+'|'+qIndex)).slice(0, 4-finalOpts.length));
  }

  finalOpts = finalOpts.slice(0,4);
  const seed = hashStr(correct + '|' + qIndex + '|stable');
  return seededShuffle(finalOpts, seed);
}

function buildGrid(state){
  const grid = document.getElementById('qGrid');
  if(grid.childElementCount === 100) return; // already built
  grid.innerHTML = '';
  for(let i=0;i<100;i++){
    const b = document.createElement('button');
    b.type = 'button';
    b.className = 'qBtn';
    b.textContent = String(i+1);
    b.addEventListener('click', () => {
      state.currentIndex = i;
      saveState(state);
      render(state);
    });
    grid.appendChild(b);
  }
}

function updateGrid(state){
  const grid = document.getElementById('qGrid');
  const btns = grid.querySelectorAll('.qBtn');
  btns.forEach((b, i) => {
    b.classList.toggle('current', i === state.currentIndex);
    b.classList.toggle('answered', !!state.answers[i]);
  });
}

function render(state){
  const idx = state.currentIndex;
  const q = state.questions[idx];

  document.getElementById('playerName').textContent = state.playerName || '匿名';
  document.getElementById('qIndex').textContent = String(idx + 1);
  document.getElementById('qTotal2').textContent = String(state.questions.length || 100);

  const img = document.getElementById('qImg');
  const imgUrl = getQField(q, ['imgUrl','imageUrl','url'], '');
  q.imgUrl = imgUrl; // normalize
  img.src = imgUrl || '';
  img.onerror = () => { img.alt = '圖片載入失敗'; };

  // ✅ 關鍵：只在「沒有 options 或不足 4」時才補齊，補好後就固定
  let opts = Array.isArray(q.options) ? uniq(q.options) : [];
  const correct = getQField(q, ['correct','answer','ans'], q.correct || '');
  q.correct = correct;
  if(opts.length !== 4){
    opts = ensureFourOptionsStable(q, idx);
    q.options = opts;
  }else{
    // 固定成 stable 版本（避免原本順序亂）
    const seed = hashStr(correct + '|' + idx + '|stable');
    q.options = seededShuffle(opts, seed);
    opts = q.options;
  }
  saveState(state);

  const chosen = state.answers[idx];
  const optionsDiv = document.getElementById('options');
  optionsDiv.innerHTML = '';

  const labels = ['A','B','C','D'];
  opts.forEach((opt, i) => {
    const lab = document.createElement('label');
    lab.className = 'opt' + (chosen === opt ? ' selected' : '');
    const radio = document.createElement('input');
    radio.type = 'radio';
    radio.name = 'opt';
    radio.value = opt;
    radio.checked = (chosen === opt);
    radio.addEventListener('change', () => {
      state.answers[idx] = opt;
      saveState(state);
      render(state);
    });
    const spanLabel = document.createElement('span');
    spanLabel.className = 'label';
    spanLabel.textContent = labels[i] + '.';
    const spanText = document.createElement('span');
    spanText.textContent = pretty(opt);

    lab.appendChild(radio);
    lab.appendChild(spanLabel);
    lab.appendChild(spanText);
    optionsDiv.appendChild(lab);
  });

  document.getElementById('prevBtn').disabled = (idx === 0);
  document.getElementById('nextBtn').disabled = (idx === 99);

  updateGrid(state);
}

function submit(state){
  let score = 0;
  const details = [];
  for(let i=0;i<100;i++){
    const q = state.questions[i];
    const correct = getQField(q, ['correct','answer','ans'], '');
    const imgUrl = getQField(q, ['imgUrl','imageUrl','url'], '');
    const a = state.answers[i];
    const ok = (a && a === correct);
    if(ok) score++;
    details.push({
      no: i+1,
      your: a,
      correct,
      ok,
      imgUrl
    });
  }
  const result = {
    playerName: state.playerName || '匿名',
    score,
    details,
    finishedAt: Date.now(),
  };
  localStorage.setItem(LS_KEYS.result, JSON.stringify(result));
  window.location.href = './result.html';
}

(async function init(){
  const warn = document.getElementById('loadWarn');
  const state = loadState();

  if(!state || !state.questions || state.questions.length !== 100){
    warn.style.display = 'block';
    warn.textContent = '找不到測驗資料（quizState_v2）。請回首頁重新開始。';
    document.getElementById('prevBtn').disabled = true;
    document.getElementById('nextBtn').disabled = true;
    document.getElementById('saveExitBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    return;
  }

  // 題目導覽
  buildGrid(state);

  // all_images.json（讓缺選項時可補齊）
  try{ await loadDb(); }catch(e){ console.warn(e); }

  // timer
  const tick = () => {
    const elapsed = (Date.now() - state.startTime) / 1000;
    const left = state.durationSec - elapsed;
    document.getElementById('timeLeft').textContent = formatTime(left);
    if(left <= 0) submit(state);
  };
  tick();
  setInterval(tick, 500);

  // buttons
  document.getElementById('prevBtn').addEventListener('click', () => {
    state.currentIndex = Math.max(0, state.currentIndex - 1);
    saveState(state);
    render(state);
  });
  document.getElementById('nextBtn').addEventListener('click', () => {
    state.currentIndex = Math.min(99, state.currentIndex + 1);
    saveState(state);
    render(state);
  });
  document.getElementById('saveExitBtn').addEventListener('click', () => {
    saveState(state);
    window.location.href = './index.html';
  });
  document.getElementById('submitBtn').addEventListener('click', () => {
    if(confirm('確定要交卷嗎？')) submit(state);
  });

  render(state);
})();
</script>
</body>
</html>
