<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作答中｜園藝丙級術科識別線上模擬測驗</title>
  <link rel="stylesheet" href="./style.css" />

<style>
  .chips{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .chip{background:#eef2ff;border-radius:999px;padding:6px 12px;font-weight:600;color:#1f2937}
  .navPanel{margin-top:18px}
  .navTitle{font-weight:700;margin:6px 0 10px 0;color:#111827}
  .navGrid{display:flex;flex-wrap:wrap;gap:8px}
  .navBtn{min-width:42px;height:38px;border-radius:10px;border:1px solid #e5e7eb;background:#f3f4f6;font-weight:700;cursor:pointer}
  .navBtn.current{outline:2px solid #3b82f6;background:#e0f2fe}
  .navBtn.answered{background:#dcfce7;border-color:#86efac}
  .optItem{display:flex;align-items:center;gap:12px;padding:14px 16px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;margin-bottom:12px}
  .optItem input{transform:scale(1.1)}
  .optItem:has(input:checked){border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,.25)}
</style>

</head>
<body>
<header>
  <div class="container">
    <h1>作答頁</h1>
    <div class="muted">40 分鐘倒數，做完可以交卷；也會在時間到時自動交卷。</div>
  </div>
</header>

<main class="container">
  <div id="errorText" style="color:#d97706;margin:10px 0;"></div>
  <div class="card">
    <div class="quizTop">
      <div class="chips"><span class="chip">考生：<span id="candidateName">—</span></span></div>
      <div class="progress">第 <span id="qIndex">1</span> / 100 題</div>
      <div class="timer">剩餘時間：<span id="timeLeft">40:00</span></div>
    </div>

    <div class="imgBox">
      <img id="qImg" alt="題目圖片" />
    </div>

    <div class="options" id="options"></div>

    <div class="navRow">
      <button class="secondary" id="prevBtn">上一題</button>
      <div class="row">
        <button class="secondary" id="saveExitBtn">儲存並離開</button>
        <button id="submitBtn">交卷</button>
      </div>
      <button class="secondary" id="nextBtn">下一題</button>
    </div>

    
    <div class="navPanel">
      <div class="navTitle">題目導覽</div>
      <div class="navGrid" id="navGrid"></div>
    </div>

    <div class="footerNote">
      規則：每題 1 個正確選項 + 3 個錯誤選項。錯誤選項必須來自「不同中文名稱」的圖片。
    </div>
  </div>
</main>



<script>
(() => {
  const STATE_KEY = 'horti_quiz_state_v3';
  const RESULT_KEY = 'horti_quiz_result_v3';
  const DURATION_SECONDS = 40 * 60;
  const LETTERS = ['A','B','C','D'];

  const $ = (id) => document.getElementById(id);
  const nowMs = () => Date.now();

  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatTime(sec){
    sec = Math.max(0, Math.floor(sec));
    const m = Math.floor(sec/60), s = sec%60;
    return `${pad2(m)}:${pad2(s)}`;
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw) return null;
      const st = JSON.parse(raw);
      if(!st || !Array.isArray(st.questions) || !Array.isArray(st.answers)) return null;
      return st;
    }catch(e){ return null; }
  }
  function saveState(st){
    try{ localStorage.setItem(STATE_KEY, JSON.stringify(st)); }catch(e){}
  }

  function nameFromPublicId(publicId){
    if(!publicId) return '';
    const parts = publicId.split('_');
    if(parts.length>=2 && /^[a-z0-9]{4,12}$/i.test(parts[parts.length-1])) parts.pop();
    if(parts.length>=2 && /^\d+$/.test(parts[parts.length-1])) parts.pop();
    return parts.join(' / ').trim();
  }

  function shuffleInPlace(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function sampleN(arr, n){
    const copy = arr.slice();
    shuffleInPlace(copy);
    return copy.slice(0, Math.min(n, copy.length));
  }

  async function fetchAllImages(){
    const res = await fetch('all_images.json', {cache:'no-store'});
    if(!res.ok) throw new Error('Failed to load all_images.json');
    return await res.json();
  }

  function buildQuestions(all){
    const folders = all.folders || {};
    const desired = { aquatic:4, fruit:20, herbaceous:20, materials:10, shrub:10, trees:10, vegetables:20, vine:6 };

    const allNamesSet = new Set();
    Object.values(folders).forEach(f => (f.images||[]).forEach(img => allNamesSet.add(nameFromPublicId(img.public_id))));
    const allNames = Array.from(allNamesSet).filter(Boolean);

    const questions = [];
    for(const [folderName, count] of Object.entries(desired)){
      const folderObj = Object.values(folders).find(f => f.folder === folderName) || folders[folderName];
      const imgs = (folderObj && folderObj.images) ? folderObj.images : [];
      const picked = sampleN(imgs, count);
      picked.forEach(img => {
        const correctName = nameFromPublicId(img.public_id);
        const wrongPool = allNames.filter(n => n && n !== correctName);
        const wrongs = sampleN(wrongPool, 3);
        const options = shuffleInPlace([correctName, ...wrongs]);
        questions.push({
          folder: folderName,
          imageUrl: img.secure_url || img.url,
          public_id: img.public_id,
          correctName,
          options,
          correctIndex: options.indexOf(correctName)
        });
      });
    }

    while(questions.length < 100){
      const anyFolder = Object.values(folders).find(f => (f.images||[]).length>0);
      if(!anyFolder) break;
      const img = anyFolder.images[Math.floor(Math.random()*anyFolder.images.length)];
      const correctName = nameFromPublicId(img.public_id);
      const wrongPool = allNames.filter(n => n && n !== correctName);
      const wrongs = sampleN(wrongPool, 3);
      const options = shuffleInPlace([correctName, ...wrongs]);
      questions.push({
        folder: anyFolder.folder,
        imageUrl: img.secure_url || img.url,
        public_id: img.public_id,
        correctName,
        options,
        correctIndex: options.indexOf(correctName)
      });
    }
    questions.length = Math.min(100, questions.length);
    shuffleInPlace(questions);
    return questions;
  }

  function render(st){
    const q = st.questions[st.currentIndex];

    $('candidateName').textContent = st.candidate || '—';
    $('qIndex').textContent = String(st.currentIndex + 1);
    $('timeLeft').textContent = formatTime((st.endsAt - nowMs())/1000);

    const imgEl = $('qImg');
    imgEl.src = q.imageUrl;
    imgEl.alt = q.correctName || '題目圖片';

    // options fixed order per question
    const chosenIdx = (typeof st.answers[st.currentIndex] === 'number') ? st.answers[st.currentIndex] : null;
    const box = $('options');
    box.innerHTML = '';
    q.options.forEach((optText, optIdx) => {
      const label = document.createElement('label');
      label.className = 'optItem';

      const input = document.createElement('input');
      input.type = 'radio';
      input.name = 'answer';
      input.value = String(optIdx);
      input.checked = chosenIdx === optIdx;

      const span = document.createElement('span');
      span.textContent = `${LETTERS[optIdx]}.  ${optText}`;

      label.appendChild(input);
      label.appendChild(span);

      label.addEventListener('click', (e) => {
        e.preventDefault();
        st.answers[st.currentIndex] = optIdx;
        saveState(st);
        render(st); // re-render but options order unchanged
      });

      box.appendChild(label);
    });

    // nav buttons
    $('prevBtn').disabled = st.currentIndex === 0;
    $('nextBtn').disabled = st.currentIndex === st.questions.length - 1;

    // nav grid (no re-randomization)
    const nav = $('navGrid');
    nav.innerHTML = '';
    for(let i=0;i<st.questions.length;i++){
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'navBtn';
      btn.textContent = String(i+1);

      if(i === st.currentIndex) btn.classList.add('current');
      if(typeof st.answers[i] === 'number') btn.classList.add('answered');

      btn.addEventListener('click', () => {
        st.currentIndex = i;
        saveState(st);
        render(st);
        window.scrollTo({top:0, behavior:'smooth'});
      });

      nav.appendChild(btn);
    }
  }

  function submit(st){
    const results = st.questions.map((q, i) => {
      const chosenIdx = (typeof st.answers[i] === 'number') ? st.answers[i] : null;
      const chosenText = (chosenIdx!==null) ? q.options[chosenIdx] : null;
      const isCorrect = chosenIdx === q.correctIndex;
      return {
        index: i+1,
        imageUrl: q.imageUrl,
        public_id: q.public_id,
        correctName: q.correctName,
        correctOption: `${LETTERS[q.correctIndex]}. ${q.correctName}`,
        chosenOption: chosenIdx===null ? null : `${LETTERS[chosenIdx]}. ${chosenText}`,
        isCorrect
      };
    });
    const score = results.reduce((a,r)=>a+(r.isCorrect?1:0),0);
    localStorage.setItem(RESULT_KEY, JSON.stringify({
      candidate: st.candidate,
      startedAt: st.startedAt,
      endedAt: nowMs(),
      score,
      total: st.questions.length,
      results
    }));
    window.location.href = 'result.html';
  }

  function tick(st){
    const remaining = Math.max(0, Math.floor((st.endsAt - nowMs())/1000));
    $('timeLeft').textContent = formatTime(remaining);
    if(remaining <= 0) submit(st);
  }

  async function main(){
    let st = loadState();
    if(!st){
      const params = new URLSearchParams(location.search);
      const candidate = params.get('name') || params.get('candidate') || params.get('id') || '';
      const all = await fetchAllImages();
      const questions = buildQuestions(all);
      st = {
        candidate,
        questions,
        answers: new Array(questions.length).fill(null),
        currentIndex: 0,
        startedAt: nowMs(),
        endsAt: nowMs() + DURATION_SECONDS*1000
      };
      saveState(st);
    }

    $('prevBtn').addEventListener('click', () => { if(st.currentIndex>0){ st.currentIndex--; saveState(st); render(st); window.scrollTo({top:0, behavior:'smooth'});} });
    $('nextBtn').addEventListener('click', () => { if(st.currentIndex<st.questions.length-1){ st.currentIndex++; saveState(st); render(st); window.scrollTo({top:0, behavior:'smooth'});} });
    $('saveExitBtn').addEventListener('click', () => { saveState(st); window.location.href='index.html'; });
    $('submitBtn').addEventListener('click', () => submit(st));

    render(st);
    setInterval(()=>tick(st), 250);
  }

  document.addEventListener('DOMContentLoaded', () => {
    main().catch(err => {
      console.error(err);
      const el = $('errorText');
      if(el) el.textContent = '載入失敗：請確認 all_images.json 與 quiz.html 在同一資料夾，並重新整理。';
    });
  });
})();
</script>

</body>
</html>